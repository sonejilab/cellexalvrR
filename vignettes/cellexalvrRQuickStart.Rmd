---
title: "A guide to using cellexalvrR - Quick Start"
author: "Stefan Lang & Shamit Soneji"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette
  
vignette: >
  %\VignetteIndexEntry{A guide to using cellexalvrR - Quick Start}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Introduction

This document describes how to use `cellexalvrR`, an R package that accompanies [CellexalVR](wwww.cellexalvr.med.lu.se) which is a virtual reality environment to analyze single-cell RNAseq data. `cellexalvrR` has two functions:

1. To aid the formatting and export of data that can be imported by CellexalVR.
2. To perform backend calculations during a CellexalVR session.

This document will focus on the first point.

## Installation

The easiest way to install `cellexalvrR` is directly from github using the `devtools` package:

```{r,eval=F}
library(devtools)
install_github("sonejilab/cellexalvrR")
```

**If you are installing this on your VR workstation then make sure you install `cellexalvrR` system-wide. Right-click the R icon, and then "Run as administrator" before issuing the commands above. Also make sure that you also have the [Rtools](https://cran.r-project.org/bin/windows/Rtools/) installed on your Windows machine which provides C and C++ compilers.
The VR log system will in addition need [pandoc](https://pandoc.org/installing.html). **

## Quick start

### Exporting files from a Seurat object

We have a simple function to convert a Seurat object to a cellexalvrR object prior to export. To demonstrate this we will use the their pbmc_small example data. 

```{r, fig.show='hold' }
library(Seurat)
library(cellexalvrR)

# We are using the seurat example pbmc_small

# We will now calculate a UMAP in 3 dimensions whereas the TSNE will be using in 2D 

pbmc_small <- RunUMAP(pbmc_small, dims = 1:10,n.components = 3)
Embeddings(pbmc_small,"umap")[1,]

# Now we convert the object to a cellexalvr object using 
# the cell identity and cluster as metadata for the cells (and any others you wish):

cvr <- as_cellexalvrR(pbmc_small,c("orig.ident","groups"), specie="human" )
cvr

# We're ready to export. Fist we create a folder cleaning out an exiting one:
opath = file.path(tempdir(),"PBMC")
if ( file.exists(opath)){
  unlink(opath, recursive=TRUE)
}
dir.create( opath )

# And here we export all data
export2cellexalvr(cvr, opath)

list.files(opath)

#Done!
```

Copy the PBMC folder and contents to the "Data"" folder where you downloaded and unpacked CellexalVR. It will then be available for loading when you step into CellexalVR.
This applies to all other data sets described here, too.

### Using AnnData objects

 We will get the 3k PBMC h5ad file from [here](http://cellexalvr.med.lu.se/downloadable/pbmc3k.zip) and unzip. It was made using [this Scanpy tutorial](https://scanpy-tutorials.readthedocs.io/en/latest/pbmc3k.html) where the only change we made was to embed the UMAP into 3 dims using `sc.tl.umap(adata,n_components=3)` :

```{r, fig.show='hold' }

remote = 'http://cellexalvr.med.lu.se/downloadable/pbmc3k.zip'
local = file.path(tempdir(), 'pbmc3k.zip')
download.file(remote, destfile = local)
utils::unzip( local, exdir = tempdir() )

cvr <- as_cellexalvrR( file.path( tempdir(), "pbmc3k.h5ad"), 
  meta.cell.groups = c( "leiden") , embeddingDims = 3, 
  specie = "human", velocity = NULL )

cvr

opath = file.path(tempdir(),"PBMC3K")
if ( file.exists(opath)){
  unlink(opath, recursive=TRUE)
}
dir.create( opath )
export2cellexalvr(cvr, opath)

list.files(opath)

#Done!
```

### Using AnnData objects from an scvelo run

If you have used scvelo to caculate cell velocities then only a couple more options need to be added to the export. In this example we ran the [demo](https://scvelo.readthedocs.io/VelocityBasics.html) with two extra lines:

```{r, fig.show='hold',eval=F}
sc.tl.umap(adata,n_components=3) # embed to 3 dims
sc.tl.leiden(adata) #get clusters
```

We can get a zip of the resulting h5ad file from [here](http://cellexalvr.med.lu.se/downloadable/pancreas_scvelo.zip). The rest is almost the same as above (in R):

```{r, fig.show='hold',eval=TRUE}
library(cellexalvrR)

#Convert("pancreas_scvelo.h5ad", dest = "h5seurat", overwrite = TRUE)
#pancreas <- LoadH5Seurat("pancreas_scvelo.h5seurat")

remote = 'http://cellexalvr.med.lu.se/downloadable/pancreas_scvelo.zip'
local = file.path(tempdir(), 'pancreas_scvelo.zip')
download.file(remote, destfile = local)
utils::unzip( local, exdir = tempdir() )

cvr <- as_cellexalvrR(file.path( tempdir(),"pancreas_scvelo.h5ad"),
  c("clusters","leiden"), specie="human",velocity="scvelo", 
  scaleArrowTravel=30)

# The deltas can be quite small, so in the line above we have 'scaleArrowTravel' 
# which multiples delta by factor specified to increase the path of travel for 
# each cell to make them more visible.

# Now we create the folder and export the CellexalVR files
opath = file.path(tempdir(),"Pancreas_scvelo")
if ( file.exists(opath)){
  unlink(opath, recursive=TRUE)
}
dir.create( opath )
export2cellexalvr(cvr, opath)

list.files(opath)

#Done!
```
**In general, to enable velocity visualisation in CellexalVR one supplies 6-column .mds files, where the last three columns denote the destination x/y/z coordinate for each cell**


### Exporting scATAC data from a Seurat object

We followed the example [here](https://satijalab.org/seurat/v3.0/atacseq_integration_vignette.html), again embedding to 3 dimensions as shown above. A zip of the RDS file can be obtained [here](http://cellexalvr.med.lu.se/downloadable/pbmc.atac.zip) which is a seurat object. Exporting the data:

```{r, fig.show='hold',eval=TRUE}

library(Seurat)
library(cellexalvrR)

remote = 'http://cellexalvr.med.lu.se/downloadable/pbmc.atac.zip'
local = file.path(tempdir(), 'pbmc.atac.zip')
download.file(remote, destfile = local)
utils::unzip( local, exdir = tempdir() )

pbmc.atac <- readRDS(file.path(tempdir(),"pbmc.atac.rds"))

# convert the object using the gene activity assay
cvr <- as_cellexalvrR(pbmc.atac,c("seurat_clusters"),specie="human",assay="ACTIVITY")
cvr

#We're ready to export. Fist make a folder if you haven't already:

opath = file.path(tempdir(),"scATAC")
if ( file.exists(opath)){
  unlink(opath, recursive=TRUE)
}
dir.create( opath )
export2cellexalvr(cvr, opath)

list.files(opath)

#Done!
```


### Making and exporting a cellexalVR object from it's elements.

If you aren't using Seurat the following guide will show you how to make a cellexalVR oject from scratch using our in-built functions. The requirments are very simple and examples are shown below.

The data from [Nestorowa *et al*](http://www.bloodjournal.org/content/128/8/e20.long?sso-checked=true) can be downloaded from [here](http://cellexalvr.med.lu.se/downloadable/cvrQuickStartData.zip). Unpack them and set your working directory to where they are.

First, load the library:

```{r, fig.show='hold',eval=T}
library(cellexalvrR)

```

```{r, include=FALSE, eval=T}
   exdata = cellexalObj@data
   facs = cellexalObj@index
   cell.ids = cellexalObj@meta.cell
   diff.proj = cellexalObj@drc$diffusion
   ddr.proj = cellexalObj@drc$DDRtree
   tsne.proj = cellexalObj@drc$tSNE
```

Then load the data:
```{r, fig.show='hold',eval=FALSE}
load("exdata.RData")
load("facs.RData")
load("cell.ids.RData")
load("diff.proj.RData")
load("ddr.proj.RData")
load("tsne.proj.RData")
```

`exdata` is a sparse matrix of highly variable genes in log2 form. The first 10 columns and 10 rows look as so:

```{r, fig.show='hold',eval=T}
exdata[1:6,1:6]
```
Note the cell IDs are in the column names, and the gene names are the row names.

```{r, fig.show='hold',eval=T}
class(exdata)
```

`facs` is a matrix of cell surface marker intensities captured during index sorting:

```{r, fig.show='hold',eval=T}
facs[1:6,1:6]
```
Cell IDs are in the row names, and the name of the surface protein in the columns.

`cell.ids` is a 1/0 matrix that assigns metadata to the each cell. In this case it shows the cell type 
each cell was sorted as:

```{r, fig.show='hold',eval=T}
cell.ids[1:6,1:6]
```
Cell IDs are in the row names, and the name of the meta data in the columns. A 1 is given if the cell 
belongs to a metadata class, 0 otherwise.

`diff.proj`,`tsne.proj`,and `diff.proj` are the results from three different dimension reduction methods 
applied to `exdata`, specifically DDRTree, tSNE and diffusion map respectively. Each is a three column matrix 
of x/y/z coordinates. For example:

```{r, fig.show='hold',eval=T}
head(diff.proj)
```

The first step is to put all the dimension reduction outputs into a single list:

```{r, fig.show='hold',eval=T}
proj.list <- list(diffusion=diff.proj,DDRtree=ddr.proj,tSNE=tsne.proj)
```

The next is to make a `cellexalvr` object by calling `MakeCellexaVRObj` and passing the required objects to it:

```{r, fig.show='hold',eval=T}
cellvr <- MakeCellexalVRObj(exdata,drc.list=proj.list,specie="mouse",
  cell.meta=cell.ids,facs.data=facs)
```
In the same step we also set the specie as mouse which ensures the correct 
transcription factor IDs are using during network construction if implemented in CellexalVR.

Calling the object name will detail it's contents:

```{r}
cellvr
```

The last step is to call `export2cellexalvr` which will write the neccessary files from the `cellvr` object 
to a specified directory:

```{r, fig.show='hold',eval=T}
opath = file.path(tempdir(),"CellexalOut")
if ( file.exists(opath)){
  unlink(opath, recursive=TRUE)
}
dir.create( opath )
export2cellexalvr(cvr, opath)

list.files( opath )

#Done!
```

All the files needed by CellexalVR are created at this point. The entire "CellexalOut/" folder should then be 
moved/copied to the "Data" folder in your CellexalVR setup. See the [manual](https://www.cellexalvr.med.lu.se/manual)
 for more details including a schematic of the folder structure.

## Making a `cellexalvr` object from scratch
While `MakeCellexalVRObj` is the most convenient way to make the object, sometimes you want to make one manually. 
This is done calling `new`:

```{r,fig.show='hold',eval=T}
cell.vr.scr <- new("cellexalvr",data=Matrix::Matrix(exdata,sparse=T),drc=list(tsne=tsne.proj))
cell.vr.scr
```

We can add another set of dimension reduction coordinates using the `addMDS2cellexalvr` function:

```{r,fig.show='hold',eval=T}
cell.vr.scr <- addDRC2cellexalvr(cell.vr.scr,ddr.proj,"DDRTree")
cell.vr.scr
```

To add metadata for each cell use `addCellMeta2cellexalvr`:
```{r,fig.show='hold',eval=T}
cell.vr.scr <- addCellMeta2cellexalvr(cell.vr.scr,cell.ids)
cell.vr.scr
```

To add FACS for each cell use `addFACS2cellexalvr`:
```{r,fig.show='hold',eval=T}
cell.vr.scr <- addFACS2cellexalvr(cell.vr.scr,facs)
```

Setting the specie is done using the `set.specie` function:

```{r,fig.show='hold',eval=T}
cell.vr.scr <- set.specie(cell.vr.scr,"mouse")
cell.vr.scr
```

## Making cell metadata from a data frame

CellexalVR requires metadata in the form of a 1/0 matrix, but many packages store it as a data frame. 
CellexalvrR has function to convert a data frame into a 1/0 matrix. First, lets make a data frame:

```{r,fig.show='hold',eval=T}
meta.df <- data.frame(CellType=sample(c("Type1","Type2","Type3"),10,replace=T),
                      Phase=sample(c("G1","G2M","S"),10,replace=T),
                      Treatment=sample(c("WT","Dox"),10,replace=T))
head(meta.df)
```

We can now make a correctly formatted cell metadata matrix by applying the function `make.cell.meta.from.df` 
using only the fields we need, in this case the "CellType" and "Treatment" columns:
```{r,fig.show='hold',eval=T}
required.cell.metad <- make.cell.meta.from.df(meta.df,c("CellType","Treatment"))
head(required.cell.metad)
```

It can be seen the field name is placed in the column heading preceeding a "@", and this is used by 
CellexalVR to form catagories on the menu system, so "CellType" and "Treatment" will be on separate tabs. 
This metadata matrix can now be added to a `cellexalvrR` object as decribed above using the `addCellMeta2cellexalvr` 
function.



